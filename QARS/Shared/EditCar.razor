@inject CarServices service
@using QARS.Data.Models 
@inject AppDbContext dbContext

<link href="/css/modal.css" rel="stylesheet" />

<EditForm Model="@UpdateCar" OnValidSubmit="UpdateCarData">
    <DataAnnotationsValidator />
    <div class="form-group">
        <label for="carmodelid">Car Model Id</label>
        <select class="form-control" @bind="@carModelId">
            @foreach (var carmodel in dbContext.CarModels)
            {
                <option value="@carmodel.Id">@carmodel.Id</option>
            }
        </select>
    </div>
    <div class="form-group">
        <label for="licenseplate">License Plate</label>
        <input type="text" id="licenseplate" class="form-control" @bind="@UpdateCar.LicensePlate" />
    </div>
    <div class="form-group">
        <label for="storeid">Store Id</label>
        <select class="form-control" @bind="@storeId">
            @foreach (var store in dbContext.Stores)
            {
                <option value="@store.Id">@store.Id</option>
            }
        </select>
    </div>
    <div class="form-group">
        <input type="checkbox" name="available" value="True" @bind="@UpdateCar.Available" />
        <label for="available">Available</label>
    </div>
    <div class="form-group">
        <label for="mileage">Mileage</label>
        <input type="text" id="mileage" class="form-control" @bind="@UpdateCar.Mileage" />
    </div>
    <div class="form-group">
        <label for="address">Address</label>
        <input type="text" id="address" class="form-control" @bind="@UpdateCar.Location.Address" />
    </div>
    <div class="form-group">
        <label for="city">City</label>
        <input type="text" id="city" class="form-control" @bind="@UpdateCar.Location.City" />
    </div>
    <div class="form-group">
        <label for="zipcode">ZipCode</label>
        <input type="text" id="zipcode" class="form-control" @bind="@UpdateCar.Location.ZipCode" />
    </div>
    <div class="form-group">
        <label for="countrycode">CountryCode</label>
        <input type="text" id="countrycode" class="form-control" @bind="@UpdateCar.Location.CountryCode" />
    </div>
    <div class="text-center p-3 mb-3">
        <button class="btn btn-warning" type="submit">Update</button>
    </div>
    <ValidationSummary />
</EditForm>

@code {
    [CascadingParameter] BlazoredModalInstance BlazoredModal { get; set; }

    [Parameter] public Car Car { get; set; }

    Car car { get; set; }
    public int storeId = 0;
    public int carModelId = 0;
    public int locationId = 0;

    protected override void OnInitialized()
    {
        car = Car;
        locationId = car.LocationId;
        carModelId = car.Model.Id;
        storeId = car.Store.Id;
        car.Location = dbContext.Locations.FirstOrDefault(x => x.Id == locationId);
        SetCarForUpdate(car);
    }

    Car UpdateCar = new Car();

    private void SetCarForUpdate(Car car)
    {
        UpdateCar = car;
    }
    private async Task UpdateCarData()
    {
        UpdateCar.Store = dbContext.Stores.FirstOrDefault(x => x.Id == storeId);
        UpdateCar.Model = dbContext.CarModels.FirstOrDefault(x => x.Id == carModelId);
        await service.UpdateCarAsync(UpdateCar);
        await BlazoredModal.Close(ModalResult.Ok<QARS.Data.Models.Car>(car));
    }
}
